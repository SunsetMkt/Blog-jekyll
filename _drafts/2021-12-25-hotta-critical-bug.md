---
title: 《幻塔》抽卡结果疑似本地生成导致的安全漏洞
date: 2021-12-25
tags:  漏洞 bug 后端 入狱警告 法律的边缘 幻塔 游戏 TCP
categories: article
---

## 简述

《幻塔》的抽卡逻辑推测如下：

* 服务器先发送当前卡池的历史记录(完整版)到本地
* 本地生成抽卡结果之后把结果附在历史记录上面发回

抽卡数据格式为JSON，内容对人类友好。

与服务器端的连接时TCP但不是HTTP协议，服务器端口是30031，此外还有个UDP的端口但不具有研究价值。

## （脱敏的）抓包记录

由于是TCP原始包，我们只在这里放上人类可读的部分和关键词，采用UTF-8尝试解码原始包数据。

### 客户端发包Upstream

```
stats data token..LotteryRecord:【编号脱敏1】:WeaponLottery_3【这个3代表第三个卡池】:0
```

### 客户端收包Downstream

```json
{
	"T": 【编号脱敏2】,
	"L": [
		[
			"bow_fire",
			"weapon_exp_r",
			1 ]
	]
},{
	"T": 【编号脱敏3】,
	"L": [
		[
			"sword_thunder",
			"weapon_exp_r",
			1 ]
	]
},【后面省略】
```

```
lottery_json_data【未知数据脱敏】.LotteryRecord:【编号脱敏1】:WeaponLottery_3:0
```

### 客户端发包Upstream

```
stats data token..LotteryRecord:【编号脱敏1】:WeaponLottery_3:0.LotteryRecord:【编号脱敏1】:WeaponLottery_3:0
```

```json
{
	"T": 【编号脱敏4】,
	"L": [
		[
			"spear_ice",
			"weapon_exp_r",
			1 ]
	]
},{
	"T": 【编号脱敏2】,
	"L": [
		[
			"bow_fire",
			"weapon_exp_r",
			1 ]
	]
},{
	"T": 【编号脱敏3】,
	"L": [
		[
			"sword_thunder",
			"weapon_exp_r",
			1 ]
	]
},【后面省略】
```

## 对于抓包记录的补充说明

需要注意，【编号脱敏1】无论何时何地何情况抽卡相同账号始终不变，推测为账号ID。

【编号脱敏2-4】推测为抽卡单号，生成原理暂时未知，但算法可能存在于本地。

新的抽卡结果`"spear_ice"`似乎在本地生成并直接附在JSON中，经事后检查确与抽卡记录相符。

服务器端返回的当前卡池抽卡数据历史似乎是完整的。

## 后记

我们不能理解，如果抽卡功能当真如此实现，客户端程序员是怀着怎样复杂的心情写下了这部分抽卡功能。

我们不能想象，当客户端抽卡结果上传之时，服务器端是在怎样的惊愕中分析出新增的结果并分发物品。

我们不能揣测，当策划发现客户可以利用网络故障轻松复现安全漏洞，看似随机的抽卡化作可重复的行为，内心是怎样的悲恸与愤慨。

我们不能共情，悲剧的主人公，在即将来临的代码重构中，即将迎来的折磨和绝望。

Bug看似修复，但在玩家群体口中描述的，是相似问题更加离谱的触发和利用......

> 本段借鉴并修改自哔哩哔哩用户@提瓦特电视频道的无关视频内容

## 特别感谢

HttpCanary 抓包、筛选和保存原始包数据

VSCode 解码并处理原始包
